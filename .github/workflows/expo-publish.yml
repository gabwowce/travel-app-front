name: Expo Publish (EAS Update)

on:
  push:
    branches: [dev, main, 'feature/**']
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest
    env:
      EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
      CI: true
      NODE_OPTIONS: --max_old_space_size=4096

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Install deps
        run: npm ci

      - name: Show Expo config (resolved)
        run: |
          npx expo --version
          npx expo config --json | node -e "
            let s='';process.stdin.on('data',d=>s+=d).on('end',()=>{
              const j=JSON.parse(s);
              console.log('owner:', j.owner);
              console.log('slug:', j.slug);
              console.log('extra.eas.projectId:', j.extra?.eas?.projectId || '(MISSING)');
              if(!j.extra?.eas?.projectId){ process.exit(2); }
            });
          "

      - name: Compute EAS branch
        run: |
          echo "GIT_BRANCH=${GITHUB_REF_NAME}" >> $GITHUB_ENV
          if [ "${GITHUB_REF_NAME}" = "main" ]; then
            echo "EAS_BRANCH=production" >> $GITHUB_ENV
          else
            echo "EAS_BRANCH=preview" >> $GITHUB_ENV
          fi
          echo "SHORT_SHA=${GITHUB_SHA::7}" >> $GITHUB_ENV

      - name: EAS Update
        run: npx --yes eas-cli@latest update --branch "$EAS_BRANCH" --auto --non-interactive --message "ci:${SHORT_SHA} (${GIT_BRANCH})"
